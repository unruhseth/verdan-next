<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verdan API Configuration Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        pre {
            white-space: pre-wrap;
            word-break: break-all;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto py-8 px-4 max-w-4xl">
        <h1 class="text-3xl font-bold mb-8 text-center text-blue-800">Verdan API Configuration Check</h1>
        
        <!-- Environment Variables -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-blue-700">Environment Variables</h2>
            
            <div class="mb-4">
                <h3 class="font-medium text-gray-700 mb-2">API URL:</h3>
                <div id="apiUrl" class="p-3 bg-gray-100 rounded font-mono text-sm"></div>
                <div id="apiUrlStatus" class="mt-1 text-sm"></div>
            </div>
            
            <div class="mb-4">
                <h3 class="font-medium text-gray-700 mb-2">Clerk Domain:</h3>
                <div id="clerkDomain" class="p-3 bg-gray-100 rounded font-mono text-sm"></div>
            </div>
            
            <div>
                <h3 class="font-medium text-gray-700 mb-2">Node Environment:</h3>
                <div id="nodeEnv" class="p-3 bg-gray-100 rounded font-mono text-sm"></div>
            </div>
        </div>
        
        <!-- API Tests -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-blue-700">API Connectivity Tests</h2>
                <button id="runTestsBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Run Tests
                </button>
            </div>
            
            <div id="testResults" class="space-y-4">
                <!-- Test results will be inserted here -->
            </div>
        </div>
        
        <!-- Manual Test -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-blue-700">Test Custom Endpoint</h2>
            
            <div class="flex mb-4">
                <input id="customUrl" type="text" placeholder="Enter API URL to test" 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-l focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button id="testCustomBtn" class="px-4 py-2 bg-blue-600 text-white rounded-r hover:bg-blue-700">
                    Test
                </button>
            </div>
            
            <div id="customTestResult" class="hidden p-4 rounded"></div>
        </div>
        
        <!-- Troubleshooting Guide -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-yellow-800">Troubleshooting Guide</h2>
            
            <div class="mb-6">
                <h3 class="font-medium text-yellow-700 mb-2">API URL Issues:</h3>
                <ul class="list-disc list-inside text-yellow-700 space-y-1">
                    <li>Environment variable <code>NEXT_PUBLIC_API_URL</code> must be set in Vercel</li>
                    <li>Must include <code>https://</code> prefix (e.g., <code>https://www.api.verdan.io</code>)</li>
                    <li>If missing protocol, browsers treat it as a relative path causing 404 errors</li>
                </ul>
            </div>
            
            <div class="mb-6">
                <h3 class="font-medium text-yellow-700 mb-2">Clerk Domain Issues:</h3>
                <ul class="list-disc list-inside text-yellow-700 space-y-1">
                    <li>Environment variable <code>NEXT_PUBLIC_CLERK_DOMAIN</code> should be set to <code>verdan.io</code> (without www)</li>
                    <li>This ensures Clerk loads from <code>clerk.verdan.io</code> instead of <code>clerk.www.verdan.io</code></li>
                    <li>Do not set <code>NEXT_PUBLIC_CLERK_FRONTEND_API</code> as it conflicts</li>
                </ul>
            </div>
            
            <div>
                <h3 class="font-medium text-yellow-700 mb-2">Fix in Vercel:</h3>
                <ol class="list-decimal list-inside text-yellow-700 space-y-1">
                    <li>Go to Vercel dashboard for your project</li>
                    <li>Navigate to Settings > Environment Variables</li>
                    <li>Add/update <code>NEXT_PUBLIC_API_URL</code> to <code>https://www.api.verdan.io</code></li>
                    <li>Add/update <code>NEXT_PUBLIC_CLERK_DOMAIN</code> to <code>verdan.io</code></li>
                    <li>Remove any conflicting variables like <code>NEXT_PUBLIC_CLERK_FRONTEND_API</code></li>
                    <li>Redeploy your application</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // Get environment variables
        const apiUrl = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : (window.NEXT_PUBLIC_API_URL || '');
        const clerkDomain = window.NEXT_PUBLIC_CLERK_DOMAIN || '';
        const nodeEnv = window.NODE_ENV || 'unknown';
        
        // Display environment variables
        document.getElementById('apiUrl').textContent = apiUrl || '(not set)';
        document.getElementById('clerkDomain').textContent = clerkDomain || '(not set)';
        document.getElementById('nodeEnv').textContent = nodeEnv;
        
        // Validate API URL
        const apiUrlStatus = document.getElementById('apiUrlStatus');
        if (!apiUrl) {
            apiUrlStatus.textContent = 'Error: NEXT_PUBLIC_API_URL is not set';
            apiUrlStatus.className = 'mt-1 text-sm text-red-600';
        } else if (!apiUrl.startsWith('http')) {
            apiUrlStatus.textContent = 'Warning: API URL does not start with http:// or https:// which can cause issues';
            apiUrlStatus.className = 'mt-1 text-sm text-yellow-600';
        } else {
            apiUrlStatus.textContent = 'Valid API URL format';
            apiUrlStatus.className = 'mt-1 text-sm text-green-600';
        }
        
        // Setup test endpoints
        const endpoints = [
            { name: 'Accounts', path: '/accounts' },
            { name: 'Apps', path: '/apps' },
            { name: 'Devices', path: '/devices' }
        ];
        
        // Run tests function
        document.getElementById('runTestsBtn').addEventListener('click', async function() {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = '';
            
            // Format API URL
            let baseUrl = apiUrl || window.location.origin;
            if (baseUrl && !baseUrl.startsWith('http')) {
                baseUrl = `https://${baseUrl}`;
            }
            
            // Run each test
            for (const endpoint of endpoints) {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'p-4 border border-gray-200 rounded';
                resultDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="loader"></div>
                        <h3 class="font-medium">${endpoint.name} (${baseUrl}${endpoint.path})</h3>
                    </div>
                    <p class="mt-2 text-gray-500">Testing...</p>
                `;
                testResults.appendChild(resultDiv);
                
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${baseUrl}${endpoint.path}`, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        cache: 'no-store'
                    });
                    const endTime = Date.now();
                    
                    if (response.ok) {
                        resultDiv.className = 'p-4 border border-green-200 bg-green-50 rounded';
                        resultDiv.innerHTML = `
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <h3 class="font-medium">${endpoint.name} (${baseUrl}${endpoint.path})</h3>
                            </div>
                            <p class="mt-2 text-green-600">Success: Status ${response.status} (${endTime - startTime}ms)</p>
                        `;
                    } else {
                        resultDiv.className = 'p-4 border border-red-200 bg-red-50 rounded';
                        resultDiv.innerHTML = `
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                <h3 class="font-medium">${endpoint.name} (${baseUrl}${endpoint.path})</h3>
                            </div>
                            <p class="mt-2 text-red-600">Failed: Status ${response.status} ${response.statusText} (${endTime - startTime}ms)</p>
                        `;
                    }
                } catch (error) {
                    resultDiv.className = 'p-4 border border-red-200 bg-red-50 rounded';
                    resultDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <h3 class="font-medium">${endpoint.name} (${baseUrl}${endpoint.path})</h3>
                        </div>
                        <p class="mt-2 text-red-600">Error: ${error.message}</p>
                    `;
                }
            }
        });
        
        // Custom test function
        document.getElementById('testCustomBtn').addEventListener('click', async function() {
            const customUrl = document.getElementById('customUrl').value;
            const resultDiv = document.getElementById('customTestResult');
            
            if (!customUrl) {
                resultDiv.className = 'p-4 border border-yellow-200 bg-yellow-50 rounded';
                resultDiv.innerHTML = '<p class="text-yellow-600">Please enter a URL to test</p>';
                resultDiv.style.display = 'block';
                return;
            }
            
            // Format URL
            const url = customUrl.startsWith('http') ? customUrl : `https://${customUrl}`;
            
            // Show loading
            resultDiv.className = 'p-4 border border-gray-200 bg-gray-50 rounded';
            resultDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="loader"></div>
                    <p>Testing ${url}...</p>
                </div>
            `;
            resultDiv.style.display = 'block';
            
            try {
                const startTime = Date.now();
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-store'
                });
                const endTime = Date.now();
                
                if (response.ok) {
                    let responseContent = '';
                    try {
                        const json = await response.json();
                        responseContent = `<pre class="mt-4 p-3 bg-black bg-opacity-5 rounded text-sm">${JSON.stringify(json, null, 2)}</pre>`;
                    } catch {
                        const text = await response.text();
                        responseContent = `<pre class="mt-4 p-3 bg-black bg-opacity-5 rounded text-sm">${text}</pre>`;
                    }
                    
                    resultDiv.className = 'p-4 border border-green-200 bg-green-50 rounded';
                    resultDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <p class="font-medium">Success: Status ${response.status} (${endTime - startTime}ms)</p>
                        </div>
                        ${responseContent}
                    `;
                } else {
                    resultDiv.className = 'p-4 border border-red-200 bg-red-50 rounded';
                    resultDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <p class="font-medium">Failed: Status ${response.status} ${response.statusText} (${endTime - startTime}ms)</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'p-4 border border-red-200 bg-red-50 rounded';
                resultDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <p class="font-medium">Error: ${error.message}</p>
                    </div>
                `;
            }
        });
        
        // Auto populate custom URL field
        document.getElementById('customUrl').value = apiUrl 
            ? `${apiUrl}/health-check` 
            : 'https://www.api.verdan.io/health-check';
            
        // Try to extract environment variables from window
        function updateWindowInfo() {
            try {
                // Try to access environment variables through Next.js public runtime
                if (window.__NEXT_DATA__ && window.__NEXT_DATA__.props && window.__NEXT_DATA__.props.pageProps) {
                    const nextData = window.__NEXT_DATA__.props.pageProps;
                    if (nextData.env) {
                        if (nextData.env.NEXT_PUBLIC_API_URL) {
                            document.getElementById('apiUrl').textContent = nextData.env.NEXT_PUBLIC_API_URL;
                        }
                        if (nextData.env.NEXT_PUBLIC_CLERK_DOMAIN) {
                            document.getElementById('clerkDomain').textContent = nextData.env.NEXT_PUBLIC_CLERK_DOMAIN;
                        }
                        if (nextData.env.NODE_ENV) {
                            document.getElementById('nodeEnv').textContent = nextData.env.NODE_ENV;
                        }
                    }
                }
                
                // Check for Clerk global variables
                if (window.__clerk_frontend_api) {
                    document.getElementById('clerkFrontendApi').textContent = window.__clerk_frontend_api;
                }
                
                // Check for any API URL in page source
                const html = document.documentElement.outerHTML;
                const apiUrlMatch = html.match(/NEXT_PUBLIC_API_URL['":\s]+([^'"]+)/);
                if (apiUrlMatch && apiUrlMatch[1]) {
                    document.getElementById('apiUrl').textContent = apiUrlMatch[1];
                }
            } catch (e) {
                console.error('Error updating window info:', e);
            }
        }
        
        // Update window info after page loads
        window.addEventListener('DOMContentLoaded', updateWindowInfo);
        setTimeout(updateWindowInfo, 1000);  // Try again after a delay
    </script>
</body>
</html>